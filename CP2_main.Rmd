---
title: "Severe Weather Events and Their Consequences in US (1950 - 2011)"
author: "Yigit Ozan Berk"
date: "5/20/2019"
output: html_document
---

Synopsis : This report tries to answer some basic questions about severe weather events in US between 1950 and 2011. 

1. Across the United States, which types of events (EVTYPE) are most harmful with respect to population health?

2. Across the United States, which types of events have the greatest economic consequences?

The report consists of two parts, *Data Processing* and *Results*. The first part shows how the data is organized for analysis. The second part shows how the final results are obtained through processed data.

-----------------------------

Contents : 
1. Data Processing
2. Results


# Data Processing

Initiation 
```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringdist)
library(data.table)
```

## Read the data file, tidy dates

```{r mainRead, cache = TRUE}
wdata <- read.csv("repdata-data-StormData.csv.bz2")

##isolating dates
#BGN_DATE
b_dates <- as.character(wdata$BGN_DATE)
b <- strsplit(b_dates, " ")
firstElement <- function(x) {x[1]}
md <- sapply(b, firstElement)
md <- as.Date(md, "%m/%d/%Y")
#put back dates
wdata$BGN_DATE <- md

#END_DATE
b_dates <- as.character(wdata$END_DATE)
b <- strsplit(b_dates, " ")
md <- sapply(b, firstElement)
md <- as.Date(md, "%m/%d/%Y")
#put back dates
wdata$END_DATE <- md

#cleaning cache
rm(b_dates, b, md)

```
## Modify damage numbers into integers with exponent columns

The 'CROPDMGEXP' is the exponent values for 'CROPDMG' (crop damage). In the same way, 'PROPDMGEXP' is the exponent values for 'PROPDMG' (property damage). You should use both to get the total values for crops and property damage. (B or b = Billion, M or m = Million, K or k = Thousand, H or h = Hundred). The number from one to ten represent the power of ten (10^The number). The symbols "-", "+" and "?" refers to less than, greater than and low certainty. You have the option to ignore these three symbols altogether.

Check how many rows contain a numeric value in EXP columns
```{r}
nrow(wdata[grepl("[0-9]", wdata$PROPDMGEXP) | grepl("[0-9]", 
                                                    wdata$CROPDMGEXP), ])

```

% 0.00035 is neglectible. 

```{r}

data <- wdata %>%

## ignoring [0-9]
## creating new column propertydamage for property damage in dollars.

  mutate(propertydamage = ifelse(grepl("k", PROPDMGEXP, 
                                       ignore.case=TRUE, perl=TRUE), 
                                 PROPDMG*1000,
         ifelse(grepl("b", PROPDMGEXP, ignore.case = TRUE, perl = TRUE), 
                PROPDMG*1000000000,
         ifelse(grepl("0", PROPDMGEXP, perl = TRUE), 
                PROPDMG,
         ifelse(grepl("m", PROPDMGEXP, ignore.case=TRUE, perl=TRUE),
                PROPDMG*1000000,
         ifelse(grepl("", PROPDMGEXP, ignore.case=TRUE, perl=TRUE),
                0,NA))))),

## creating new column cropdamage for crop damage in dollars

         cropdamage = ifelse(grepl("k", CROPDMGEXP, 
                                   ignore.case=TRUE, perl=TRUE), 
                             CROPDMG*1000,
         ifelse(grepl("0", CROPDMGEXP, perl = TRUE), 
                CROPDMG,
         ifelse(grepl("b", CROPDMGEXP, ignore.case = TRUE, perl = TRUE),
                CROPDMG*1000000000,
         ifelse(grepl("m", CROPDMGEXP, ignore.case=TRUE, perl=TRUE),
                CROPDMG*1000000,
         ifelse(grepl("", PROPDMGEXP, ignore.case=TRUE, perl=TRUE),
                0,NA))))),

## creating new column totaldamage which the total damage in dollars

         totaldamage=propertydamage+cropdamage

        )


```

## Tidying the EVTYPE column

```{r damages}
str(unique(data$EVTYPE))
```
There should be 48 official events, but there are 985 different levels of EVTYPE 
column. *The typos must be corrected.*

```{r}
data$EVTYPE <- toupper(data$EVTYPE)
str(unique(data$EVTYPE))
```

Reduced a little but not much.

Let's see the word count of each event type.

```{r}
words <- paste(data$EVTYPE, collapse = " ")
uniqueWords <- strsplit(words, " ")[[1]]
wordCount <- as.data.frame(table(uniqueWords)) %>% arrange(desc(Freq))
head(wordCount, 50)
#the most used words
```

Check the total damage before further processing

```{r}
i_sum <- sum(data$totaldamage)
i_sum
```

A new list cross-matching official event types and most appeared event names
on EVTYPE column is created to create a clean set of EVTYPE column.

```{r}
temp <- data %>% select(BGN_DATE, STATE, EVTYPE, FATALITIES, INJURIES, propertydamage, cropdamage, totaldamage) %>% as.data.table()

## Weather events are recoded using regex and the data.table package
temp[grepl("TSTM|THUNDERSTORM|LIGHTNING", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="thunderstorm"]
temp[grepl("WIND|MICROBURST|(?=.*MICRO)(?=.*BURST)", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="wind"]
temp[grepl("HAIL", EVTYPE, ignore.case=TRUE), EVTYPE:="hail"]
temp[grepl("FLOOD|FLD", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="flood"]
temp[grepl("TORNADO|FUNNEL|WATERSPOUT", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="tornado"]
temp[grepl("SLEET|SNOW", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="sleet and snow"]
temp[grepl("RAIN", EVTYPE, ignore.case=TRUE), EVTYPE:="rain"]
temp[grepl("SURF|TIDE|SURGE|RIP|CURRENT", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="surftide"]
temp[grepl("ICE|FREEZ|FROST|FROZEN|COLD|CHILL", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="cold"]
temp[grepl("BLIZZARD|(?=.*ICE)(?=.*STORM)|(?=.*SNOW)(?=.*STORM)|(?=.*WINTER)(?=.*STORM)|(?=.*LAKE)(?=.*EFFECT)", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="blizzard"]
temp[grepl("DUST", EVTYPE, ignore.case=TRUE), EVTYPE:="dust"]
temp[grepl("WILDFIRE|(?=.*WILD)(?=.*FIRE)|(?=.*FOREST)(?=.*FIRE)", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="fire"]
temp[grepl("HEAT|WARM", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="heat"]
temp[grepl("(?=.*DRY)(?=.*WARM)|DROUGHT", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="drought"]
temp[grepl("FOG", EVTYPE, ignore.case=TRUE), EVTYPE:="fog"]
temp[grepl("HURRICANE|TYPHOON|(?=.*TROPICAL)(?=.*STORM)(?=.*depression)", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="tropical storm"]
temp[grepl("LANDSLIDE", EVTYPE, ignore.case=TRUE), EVTYPE:="landslide"]
temp[grepl("AVALANCHE", EVTYPE, ignore.case=TRUE), EVTYPE:="avalanche"]

## Only observations with any of the new types of weather are kept.
processedData <- temp %>% filter(grepl("^thunderstorm$|^wind$|^hail$|^flood$|^tornado$|^sleet and snow$|^rain$|^surftide$|^cold$|^blizzard$|^dust$|^fire$|^heat$|^drought$|^fog$|^tropical storm$|^landslide$|^avalanche$", EVTYPE, perl=TRUE)) %>% as.data.frame()

processedData$EVTYPE <- as.factor(as.character(processedData$EVTYPE))

```

The difference between the original data and the processed data
```{r}
nrow(processedData)/nrow(data)
```
%0.99 difference in the number of observed cases

```{r}
p_sum <- sum(processedData$totaldamage)
p_sum/i_sum
```
%0.98 difference in the cost of total damage

```{r}
i_sum - p_sum
```

The neglected damage in the processed data set is 8.756 billion dollars.




-Fatality codes : REMARKS column. need to modify string.
-Fatality N : FATALITIES column 
-Injuries : INJURIES colummn
-Econ. Damage : PROPDMG , PROPDMGEXP
-Econ. Damage : CROPDMG , CROPDMGEXP
-Beginning Date : BGN_DATE %m/%d/%Y 0:00:00
-Beginnign Time : BGN_TIME %
-End Date : END_DATE
-End Time : END_TIME
-Time Zone : TIME_ZONE - 3 letter string
-State : STATE__, STATE
-Event Type : EVTYPE
-Zone Names : ZONENAMES

WFO = Weather Forecast Office, F = Fujita tornado intensity scale (F-Scale), MAG = Magnitude, or Strength, of the event. It is required by NOAA for Wind and Hail events if it is known. Wind Events are in KNOTS. Hail is in INCHES and TENTHS without the decimal (one and one-half are150).

LENGTH = Path length of a tornado (in miles and tenths of miles). 
WIDTH = Path width of a tornado, in yards. According to NOAA documentation the length and width used for all tornadoes, including each member of families of tornadoes, or for all segments of multi-segmented tornadoes.

According to NOAA the data recording start from Jan. 1950. At that time they recorded one event type, tornado. They add more events gradually and only from Jan. 1996 they start recording all events type. Since our objective is comparing the effects of different weather events, do we need to include all years, even it has only single event type?
*Graph and drop events before 1996*

*EVTYPE COLUMN*
The official events type are 48. However, if you use 'unique' function on 'EVTYPE' column you will get near one thousand events! All that is just typo. The regular expression ('regex', grepl, regexpr, gregexpr) and 'tolower', and 'toupper' functions can be a great help here. But cleaning up all that mess can take several days. However, reducing the size of data first will make a great difference here. Subset your data first, think of years, total value, frequency ... anything else that can be used to reduce the number of rows. Also, there are 37 variables, you do not need all of that for your analysis, remove as much as you can to make the analysis faster.

Back to 'EVTYPE' column, one way to fix the typo is loading the official list of storm event types and manually mapping all (or most) list of unique recorded events with a typo. This way is the most painful one. Another way is using 'match' (from 'base' package) or even better you may use 'amatch' function from 'stringdist' package for Approximate String Matching. In that case, you will need to experiments with 'maxDist' option to get good accuracy.




# Results  **Not more than 3 figures(each figure can have multiple plots)**
Does the analysis address the question of which types of events are most harmful to population health?

Does the analysis address the question of which types of events have the greatest economic consequences?

