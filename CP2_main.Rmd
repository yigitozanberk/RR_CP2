---
title: "Severe Weather Events and Their Consequences in US (1996 - 2011)"
author: "Yigit Ozan Berk"
date: "5/20/2019"
output: html_document
---

Synopsis : This report tries to answer some basic questions about severe weather events in US according to NOAA report. 

1. Across the United States, which types of events (EVTYPE) are most harmful with respect to population health?

2. Across the United States, which types of events have the greatest economic consequences?

The report consists of two parts, *Data Processing* and *Results*. The first part shows how the data is organized for analysis. The second part shows how the final results are obtained through processed data.

-----------------------------

Contents : 
1. Data Processing
2. Results


# Data Processing

Initiation 
```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(data.table)
```

## Read the data file

Read and tidy dates
```{r mainRead, cache = TRUE}
wdata <- read.csv("repdata-data-StormData.csv.bz2")

##isolating dates
#BGN_DATE
b_dates <- as.character(wdata$BGN_DATE)
b <- strsplit(b_dates, " ")
firstElement <- function(x) {x[1]}
md <- sapply(b, firstElement)
md <- as.Date(md, "%m/%d/%Y")
#put back dates
wdata$BGN_DATE <- md

#END_DATE
b_dates <- as.character(wdata$END_DATE)
b <- strsplit(b_dates, " ")
md <- sapply(b, firstElement)
md <- as.Date(md, "%m/%d/%Y")
#put back dates
wdata$END_DATE <- md

#cleaning cache
rm(b_dates, b, md)

```
## Tidying CROPDMG, and PROPDMG. Modify damage numbers into integers with exponent columns

The 'CROPDMGEXP' is the exponent values for 'CROPDMG' (crop damage). In the same way, 'PROPDMGEXP' is the exponent values for 'PROPDMG' (property damage). You should use both to get the total values for crops and property damage. (B or b = Billion, M or m = Million, K or k = Thousand, H or h = Hundred). The number from one to ten represent the power of ten (10^The number). The symbols "-", "+" and "?" refers to less than, greater than and low certainty. 

Check how many rows contain a numeric value in EXP columns
```{r}
nrow(wdata[grepl("[0-9]", wdata$PROPDMGEXP) | grepl("[0-9]", 
                                                    wdata$CROPDMGEXP), ])

```

% 0.00035 is neglectible. Values with symbols "-", "+" and "?" are dropped along with characters [1-9].

```{r}

data <- wdata %>%

## ignoring [0-9]
## creating new column propertydamage for property damage in dollars.

  mutate(propertydamage = ifelse(grepl("k", PROPDMGEXP, 
                                       ignore.case=TRUE, perl=TRUE), 
                                 PROPDMG*1000,
         ifelse(grepl("b", PROPDMGEXP, ignore.case = TRUE, perl = TRUE), 
                PROPDMG*1000000000,
         ifelse(grepl("0", PROPDMGEXP, perl = TRUE), 
                PROPDMG,
         ifelse(grepl("m", PROPDMGEXP, ignore.case=TRUE, perl=TRUE),
                PROPDMG*1000000,
         ifelse(grepl("", PROPDMGEXP, ignore.case=TRUE, perl=TRUE),
                0,NA))))),

## creating new column cropdamage for crop damage in dollars

         cropdamage = ifelse(grepl("k", CROPDMGEXP, 
                                   ignore.case=TRUE, perl=TRUE), 
                             CROPDMG*1000,
         ifelse(grepl("0", CROPDMGEXP, perl = TRUE), 
                CROPDMG,
         ifelse(grepl("b", CROPDMGEXP, ignore.case = TRUE, perl = TRUE),
                CROPDMG*1000000000,
         ifelse(grepl("m", CROPDMGEXP, ignore.case=TRUE, perl=TRUE),
                CROPDMG*1000000,
         ifelse(grepl("", PROPDMGEXP, ignore.case=TRUE, perl=TRUE),
                0,NA))))),

## creating new column totaldamage which the total damage in dollars

         totaldamage=propertydamage+cropdamage

        )

#cleanCache
rm(wdata)
```

## Tidying the EVTYPE column

```{r damages}
str(unique(data$EVTYPE))
```

There should be 48 official events, but there are 985 different levels of EVTYPE 
column. *The typos must be corrected.*

```{r}
data$EVTYPE <- toupper(data$EVTYPE)
str(unique(data$EVTYPE))
```

Reduced a little but not much.

Let's see the word count of each event type.

```{r}
words <- paste(data$EVTYPE, collapse = " ")
uniqueWords <- strsplit(words, " ")[[1]]
wordCount <- as.data.frame(table(uniqueWords)) %>% arrange(desc(Freq))
head(wordCount, 50)
#the most used words
```

Check the total damage before further processing

```{r}
i_sum <- sum(data$totaldamage)
i_sum
```

A new list cross-matching official event types and most appeared event names
on EVTYPE column is created to create a clean set of EVTYPE column.

```{r}
temp <- data %>% select(BGN_DATE, STATE, EVTYPE, FATALITIES, INJURIES, propertydamage, cropdamage, totaldamage) %>% as.data.table()

## Weather events are recoded using regex and the data.table package
temp[grepl("TSTM|THUNDERSTORM|LIGHTNING", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="thunderstorm"]
temp[grepl("WIND|MICROBURST|(?=.*MICRO)(?=.*BURST)", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="wind"]
temp[grepl("HAIL", EVTYPE, ignore.case=TRUE), EVTYPE:="hail"]
temp[grepl("FLOOD|FLD", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="flood"]
temp[grepl("TORNADO|FUNNEL|WATERSPOUT", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="tornado"]
temp[grepl("SLEET|SNOW", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="sleet and snow"]
temp[grepl("RAIN", EVTYPE, ignore.case=TRUE), EVTYPE:="rain"]
temp[grepl("SURF|TIDE|SURGE|RIP|CURRENT", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="surftide"]
temp[grepl("ICE|FREEZ|FROST|FROZEN|COLD|CHILL", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="cold"]
temp[grepl("BLIZZARD|(?=.*ICE)(?=.*STORM)|(?=.*SNOW)(?=.*STORM)|(?=.*WINTER)(?=.*STORM)|(?=.*LAKE)(?=.*EFFECT)", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="blizzard"]
temp[grepl("DUST", EVTYPE, ignore.case=TRUE), EVTYPE:="dust"]
temp[grepl("WILDFIRE|(?=.*WILD)(?=.*FIRE)|(?=.*FOREST)(?=.*FIRE)", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="fire"]
temp[grepl("HEAT|WARM", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="heat"]
temp[grepl("(?=.*DRY)(?=.*WARM)|DROUGHT", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="drought"]
temp[grepl("FOG", EVTYPE, ignore.case=TRUE), EVTYPE:="fog"]
temp[grepl("HURRICANE|TYPHOON|(?=.*TROPICAL)(?=.*STORM)(?=.*depression)", EVTYPE, perl=TRUE, ignore.case=TRUE), EVTYPE:="tropical storm"]
temp[grepl("LANDSLIDE", EVTYPE, ignore.case=TRUE), EVTYPE:="landslide"]
temp[grepl("AVALANCHE", EVTYPE, ignore.case=TRUE), EVTYPE:="avalanche"]

## Only observations with any of the new types of weather are kept.
processedData <- temp %>% filter(grepl("^thunderstorm$|^wind$|^hail$|^flood$|^tornado$|^sleet and snow$|^rain$|^surftide$|^cold$|^blizzard$|^dust$|^fire$|^heat$|^drought$|^fog$|^tropical storm$|^landslide$|^avalanche$", EVTYPE, perl=TRUE)) %>% as.data.frame()

processedData$EVTYPE <- as.factor(as.character(processedData$EVTYPE))

```

The difference between the original data and the processed data

```{r}
nrow(processedData)/nrow(data)
```
%1.109 difference in the number of observed cases, proceeding.

```{r}
p_sum <- sum(processedData$totaldamage)
p_sum/i_sum
```
%1.18 difference in the cost of total damage, proceeding.

```{r}
i_sum - p_sum
```

Side note : The neglected damage in the processed data set(%1.18 compared to 
observed total damage) is 8.756 billion dollars.


## Further notes on EVTYPE

Upon further examination of the EVTYPE column, there are some biases about the recorded
event types. Before the date 1996-01-01, there are extreme differences on the % 
of recorded event types
```{r}
myd <- filter(processedData, BNG_DATE < "1996-01-01")
nrow(myd)/nrow(processedData)
```
While the number of observations before 1996 is around %28 of the number of observations until 2011,
```{r}
summary(myd$EVTYPE)/summary(processedData$EVTYPE)
```
the number of observations of some event types differ very drastically .

According to [NOAA](https://www.ncdc.noaa.gov/stormevents/details.jsp?type=eventtype) the data recording start from Jan, 1950. However, at that time, they recorded one event type, tornado. They add Thunderstorm, Wind and Hail starting from Jan, 1955, but they only start adding all event types from Jan, 1996. 

Therefore, for a more unbiased analysis all observations before Jan 1996 are dropped.

```{r}
tdata <- filter(processedData, BGN_DATE > "1996-01-01")
# clean unused tables
rm(data, myd, processedData, temp)
head(tdata)
```



# Results **One figure for each question. An extra figure if need be**

## Question : Across the United States, which types of events (EVTYPE) are most harmful with respect to population health?

Firstly, let's look at the mean and sum values of fatalities and injuries for every event type.

```{r}
tdata%>% group_by(EVTYPE) %>% summarise(n = n(), 
                                        meanFAT = mean(FATALITIES, na.rm = T),
                                        sumFAT = sum(FATALITIES, na.rm = T),
                                        meanINJ = mean(INJURIES, na.rm = T),
                                        sumINJ = sum(INJURIES, na.rm = T)) %>%
        arrange(desc(sumFAT, sumINJ))
```



## Question : Across the United States, which types of events have the greatest economic consequences?


Does the analysis address the question of which types of events have the greatest economic consequences?

